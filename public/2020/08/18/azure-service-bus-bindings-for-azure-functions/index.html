<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Azure Service Bus bindings for Azure Functions - Salman Ali Banani</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Azure Service Bus bindings for Azure Functions" />
<meta property="og:description" content="How to use Azure Service Bus bindings for Azure Functions to simplify your glue code" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://salmanalibanani.netlify.app/2020/08/18/azure-service-bus-bindings-for-azure-functions/" />
<meta property="article:published_time" content="2020-08-18T09:31:13+10:00" />
<meta property="article:modified_time" content="2020-08-18T09:31:13+10:00" />

	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
	<script type="text/javascript">
   	var sdkInstance="appInsightsSDK";window[sdkInstance]="appInsights";var aiName=window[sdkInstance],aisdk=window[aiName]||function(e){function n(e){t[e]=function(){var n=arguments;t.queue.push(function(){t[e].apply(t,n)})}}var t={config:e};t.initialize=!0;var i=document,a=window;setTimeout(function(){var n=i.createElement("script");n.src=e.url||"https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js",i.getElementsByTagName("script")[0].parentNode.appendChild(n)});try{t.cookie=i.cookie}catch(e){}t.queue=[],t.version=2;for(var r=["Event","PageView","Exception","Trace","DependencyData","Metric","PageViewPerformance"];r.length;)n("track"+r.pop());n("startTrackPage"),n("stopTrackPage");var s="Track"+r[0];if(n("start"+s),n("stop"+s),n("setAuthenticatedUserContext"),n("clearAuthenticatedUserContext"),n("flush"),!(!0===e.disableExceptionTracking||e.extensionConfig&&e.extensionConfig.ApplicationInsightsAnalytics&&!0===e.extensionConfig.ApplicationInsightsAnalytics.disableExceptionTracking)){n("_"+(r="onerror"));var o=a[r];a[r]=function(e,n,i,a,s){var c=o&&o(e,n,i,a,s);return!0!==c&&t["_"+r]({message:e,url:n,lineNumber:i,columnNumber:a,error:s}),c},e.autoExceptionInstrumented=!0}return t}(
   	{
      	instrumentationKey:"91eaa82c-9aa3-4717-8825-e0a2921473da"
   	}
   	);window[aiName]=aisdk,aisdk.queue&&0===aisdk.queue.length&&aisdk.trackPageView({});
	</script>
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Salman Ali Banani" rel="home">
			<div class="logo__item logo__text float-left">
					<div class="logo__title">Salman Ali Banani

					</div>

					
				</div>
		</a>
		<br />
		
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/2020/02/01/about/">
				
				<span class="menu__text">About</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/2020/07/16/archives/">
				
				<span class="menu__text">Archives</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/2020/07/24/docker-scratchpad/">
				
				<span class="menu__text">Docker Scratchpad</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Azure Service Bus bindings for Azure Functions</h1>
			<br />
			August 18, 2020
			
		</header><div class="content post__content clearfix">
			

<p>As we use more PAAS/serverless services on the cloud, we must find ways to integrate these services with each other to build features that our customers want.  <a target="_blank" href="https://docs.microsoft.com/en-us/azure/azure-functions/">Azure Functions</a> is one offering where you often end up fetching information from other services, or passing on stuff to those services.  In this article we will see how we can simplify integration between Azure Functions and <a target="_blank" href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/">Azure Service Bus</a>.</p>

<h2 id="output-binding-and-triggers">Output Binding and Triggers</h2>

<p>Azure Service Bus is an enterprise integration message broker, and sometimes we need a service like that to decouple various parts of our solution on the cloud.  Azure Functions can interact with Service Bus in various ways:</p>

<ul>
<li>We can use <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-service-bus-output" target="_blank">output binding</a> to send messages from a Function App to a Service Bus.</li>
<li>We can use a <a href ="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-service-bus-trigger" target="_blank">trigger</a> to respond to messages from Service Bus queue or topic.<br /></li>
</ul>

<h2 id="output-binding">Output Binding</h2>

<p>Here is an example of how you would pass a message to a Service Bus queue without using output binding.</p>

<pre><code>[FunctionName("MyFunctionName")]
public static async void Run([HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req, ILogger log)
{
    string queueName = Environment.GetEnvironmentVariable("QueueName");
    string serviceBusConnectionString = System.Environment.GetEnvironmentVariable("ServiceBusConnectionString");

    string requestBody = await new StreamReader(req.Body).ReadToEndAsync();

    var client = new QueueClient(serviceBusConnectionString, queueName);
    var message = new Message(Encoding.UTF8.GetBytes(requestBody));

    await client.SendAsync(message);
}</code></pre>

<p>It is a fairly straightforward approach.  You read the service bus connection string and queue name from environment, and create a QueueClient object to pass a message to a queue.</p>

<p>With output binding, you can write something like this:
<pre><code>[FunctionName(&ldquo;MyFunctionName&rdquo;)]
public static void Run([HttpTrigger(AuthorizationLevel.Function, &ldquo;get&rdquo;, &ldquo;post&rdquo;, Route = null)] HttpRequest req, ILogger log,
    [ServiceBus(&ldquo;replyqueue&rdquo;, Connection = &ldquo;ServiceBusConnectionString&rdquo;, EntityType = EntityType.Queue)] out string queueMessage)
{
    string requestBody = new StreamReader(req.Body).ReadToEnd();
    queueMessage = requestBody;
}</code></pre></p>

<p>This is a more declarative way of working with Azure Functions and Service Bus.   The output variable is passed on to the queue that we have specified through &ldquo;ServiceBus&rdquo; attribute.  The function now has one less dependency (QueueClient) which makes it potentially more unit-testable.</p>

<p>You can also move the attributes to the function level instead of the output parameter.
<pre><code>[FunctionName(&ldquo;MyFunctionName&rdquo;)]
[return: ServiceBus(&ldquo;replyqueue&rdquo;, Connection = &ldquo;ServiceBusConnectionString&rdquo;)]
public static string Run([HttpTrigger(AuthorizationLevel.Function, &ldquo;get&rdquo;, &ldquo;post&rdquo;, Route = null)] HttpRequest req, ILogger log)
{
    string requestBody = new StreamReader(req.Body).ReadToEnd();
    return requestBody;
}</code></pre>
This is somewhat more readable because the function&rsquo;s return value is now being passed to the queue.</p>

<h2 id="triggers">Triggers</h2>

<p>Triggers are a way to interact with a Service Bus in the opposite direction.  You can fire a Function from a Service Bus queue or topic.  You can simply supply the queue name and connection information using the &ldquo;ServiceBusTrigger&rdquo; attribute.</p>

<pre><code>[FunctionName("QueueTrigger")]
public static void Run([ServiceBusTrigger("replyqueue", AccessRights.Manage, Connection = "ServiceBusConnectionSetting")]string message, TraceWriter log)
{
    // Do something with the message.
    log.Info(message");
}</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>Understanding how to effectively connect Azure services with each other is a key skill to implement successful solutions on Azure.  In this post, we demonstrated how to use Azure Service Bus bindings and triggers to work with Azure Functions and Service Bus.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/azure/" rel="tag">Azure</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/service-bus/" rel="tag">Service Bus</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/functions/" rel="tag">Functions</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/2020/08/18/azure-service-bus-bindings-for-azure-functions/">Azure Service Bus bindings for Azure Functions</a></li>
			<li class="widget__item"><a class="widget__link" href="/2020/07/20/migrating-my-blog-to-hugo-netlify/">Migrating My Blog to Hugo &amp; Netlify</a></li>
			<li class="widget__item"><a class="widget__link" href="/2020/07/14/pushing-secrets-into-azure-key-vault-directly-from-arm-template/">Pushing Secrets Into Azure Key Vault Directly From Arm Template</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/agile/" title="Agile">Agile</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/azure/" title="Azure">Azure</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/blogging/" title="Blogging">Blogging</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/devops/" title="DevOps">DevOps</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/functions/" title="Functions">Functions</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/key-vault/" title="Key Vault">Key Vault</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/philosophy/" title="Philosophy">Philosophy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/scrum/" title="Scrum">Scrum</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/service-bus/" title="Service Bus">Service Bus</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/software-consulting/" title="Software Consulting">Software Consulting</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer_links">
			&copy; 2020 Salman Ali Banani.	
		</div>
		<div class="footer__copyright">
			<span class="socials"><a target="_blank" href="https://twitter.com/salmanalibanani" class="fa fa-twitter" style="text-decoration:none; font-size:16px"></a></span>
			<span class="socials"><a target="_blank" href="https://au.linkedin.com/in/salmanalibanani" class="fa fa-linkedin" style="text-decoration:none; font-size:16px"></a></span>
			<span class="socials"><a target="_blank" href="https://github.com/salmanalibanani" class="fa fa-github" style="text-decoration:none; font-size:16px"></a></span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>